<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Wikisource (All Validated Works)</title>
        <link rel="stylesheet" href="css/foundation.min.css" />
        <link rel="stylesheet" href="css/style.css" />
        <script src="js/modernizr.js"></script>
    </head>
    <body>

        <div class="row">
            <div class="large-12 columns">
                <h1>Wikisource <small>(All Validated Works)</small></h1>
                <p>
                    This page presents the categorisation of the <span id="total-works">x</span> works
                    on the <a href="https://en.wikisource.org/">English Wikisource</a>
                    that are categorised, backed by scans,
                    and have been validated (i.e. proofread by at least two contributors).
                </p>
                <p class="loading"><img src="img/loading.gif" /> Categories loading, please wait...</p>
                <ol class="c hide" id="catlist"></ol>
                <p>
                    This list was last updated at:
                    <span id="last-mod">y</span> <a href="http://time.is/UTC">UTC</a>.
                </p>
                <p>
                    For more information please see
                    <a href="https://github.com/samwilson/wikisource-cat-browser">the code</a> on Github
                    or contact <a href="https://en.wikisource.org/wiki/User:Samwilson">User:Samwilson</a>.
                    The above data is available in <a href="works.json"><tt>works.json</tt></a>
                    and <a href="categories.json"><tt>categories.json</tt></a>.
                </p>
            </div>
        </div>

        <div class="hide">
            <img src='https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/EPUB_silk_icon.svg/15px-EPUB_silk_icon.svg.png' />
        </div>
        <script src="js/jquery.js"></script>
        <script src="js/foundation.min.js"></script>
        <script>
            $(document).foundation();
            $(function() {
                // Get categories.
                $.get("categories.json", null, function(allCats){
                    $(".loading").fadeOut(400, function(){
                        $("#catlist").removeClass("hide").fadeIn(400);
                    });

                    // Last modified date.
                    $.get("build.php", null, function(metadata){
                        $("#last-mod").text(metadata.last_modified);
                        $("#total-works").text(metadata.works_count);
                    });

                    // Add categories.
                    addCats(allCats, $("#catlist"), allCats["Category:Categories"]);
                });
            });
            function addCats(allCats, $parent, cat) {
                $.each(cat, function(i, subcat){
                    var title = subcat.replace(/_/g, " ");
                    if (subcat.substr(0, 9)=="Category:") {
                        title = '<span>'+title.substr(9)+'</span>';
                    } else {
                        var encodedCat = encodeURIComponent(subcat);
                        title = "<a href='https://en.wikisource.org/wiki/"+encodedCat+"' title='View on Wikisource'>"+title+"</a>"
                            + "<a href='http://wsexport.wmflabs.org/tool/book.php?lang=en&format=epub&page="+encodedCat+"' class='epub'>"
                            + " <img src='https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/EPUB_silk_icon.svg/15px-EPUB_silk_icon.svg.png'"
                            + "     title='Download EPUB' />"
                            + "</a>";
                    }
                    var $newItem = $("<li class='c'>"+title+"<ol class='c'></ol></li>");
                    $parent.append($newItem);
                    $newItem.find("span").on("click", function(){
                        var $sublist = $(this).next("ol");
                        if ($sublist.is(":empty")) {
                            $(this).addClass("open").removeClass("closed");
                            addCats(allCats, $sublist, allCats[subcat]);
                        } else {
                            $(this).addClass("closed").removeClass("open");
                            $sublist.children().remove();
                        }
                    })
                });
            }
        </script>
    </body>
</html>
